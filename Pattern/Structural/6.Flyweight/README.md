# 6. Приспособленец (Flyweight)

Суть: Экономит память, разделяя общие части объектов.

Шаблон «Лёгкий вес» — это структурный шаблон проектирования, который используется для оптимизации использования памяти и повышения производительности при работе с большим количеством объектов, имеющих некоторые общие характеристики. Это достигается за счёт отделения внутреннего состояния объекта (общего для нескольких объектов) от его внешнего состояния (уникального для каждого объекта) и хранения внутреннего состояния во внешнем хранилище, обычно на фабрике «Лёгкий вес». Этот шаблон особенно полезен, когда нужно создать большое количество похожих объектов и минимизировать занимаемую ими память.

## Задача
>_Во многих приложениях может потребоваться создание большого количества объектов с некоторыми общими свойствами или характеристиками. Без оптимизации это может привести к чрезмерному расходу памяти, поскольку каждый объект содержит дублирующиеся данные об общих свойствах. Кроме того, это может повлиять на производительность из-за дополнительных затрат на создание множества объектов и управление ими._

## Ключевые компоненты паттерна Приспособленец
1. __Лёгкий интерфейс или базовый класс:__ 
Здесь определены методы для доступа к внутреннему состоянию и управления им.
2. __Concrete Flyweight:__ 
Реализации интерфейса Flyweight, которые хранят внутреннее состояние и управляют им. Как правило, они легковесны и могут использоваться совместно.
3. __Фабрика легковесных объектов:__ 
Класс фабрики, отвечающий за создание легковесных объектов и управление ими. Он обеспечивает совместное использование легковесных объектов и их повторное применение, когда это возможно.

## Диаграмма паттерна Приспособленец
<figure>
    <img src ="/assets/images/Diagram_Flyweight.png" alt = "Flyweight">
</figure>

## Пример
```c++
class TreeType {
private:
    std::string name;
    std::string color;
public:
    TreeType(const std::string& name, const std::string& color) 
        : name(name), color(color) {}
    void draw(int x, int y) {
        std::cout << "Drawing " << name << " (" << color << ") at (" << x << ", " << y << ")" << std::endl;
    }
};

class TreeFactory {
private:
    static std::map<std::string, TreeType*> treeTypes;
public:
    static TreeType* getTreeType(const std::string& name, const std::string& color) {
        auto it = treeTypes.find(name);
        if (it == treeTypes.end()) {
            treeTypes[name] = new TreeType(name, color);
        }
        return treeTypes[name];
    }
};

std::map<std::string, TreeType*> TreeFactory::treeTypes;

class Tree {
private:
    int x, y;
    TreeType* type;
public:
    Tree(int x, int y, TreeType* type) : x(x), y(y), type(type) {}
    void draw() {
        type->draw(x, y);
    }
};

int main() {
    TreeType* oak = TreeFactory::getTreeType("Oak", "Green");
    Tree tree1(10, 20, oak);
    Tree tree2(30, 40, oak);
    tree1.draw();  // Drawing Oak (Green) at (10, 20)
    tree2.draw();  // Drawing Oak (Green) at (30, 40)
    return 0;
}
```

## Преимущества шаблона проектирования Приспособленец
✅ __Эффективность использования памяти:__ Основное преимущество шаблона Flyweight заключается в его способности значительно сокращать потребление памяти. Благодаря общему внутреннему состоянию нескольких объектов можно избежать хранения избыточных данных, что особенно ценно при работе с большим количеством похожих объектов.

✅ __Повышение производительности:__ Сокращение использования памяти часто приводит к повышению производительности. Меньшее количество операций выделения и освобождения памяти может привести к ускорению создания объектов и снижению накладных расходов, что делает приложение более эффективным.

✅ __Повторное использование объектов:__ легковесные объекты предназначены для повторного использования. Вместо создания нового объекта для каждого экземпляра шаблон предполагает повторное использование существующих объектов с тем же внутренним состоянием. Это способствует эффективному управлению памятью и ресурсами.

✅ __Масштабируемость:__ паттерн Flyweight хорошо подходит для приложений, которым необходимо эффективное масштабирование, особенно в ситуациях, когда требуется большое количество объектов. Он помогает сделать использование памяти предсказуемым и управляемым по мере роста приложения.

✅ __Упрощённый дизайн:__ благодаря отделению внутреннего состояния от внешнего и использованию общих служебных данных дизайн приложения становится более простым и модульным. Это способствует чёткому разделению задач и сохранению ясного различия между общими и уникальными данными.

✅ __Снижение нагрузки на объекты:__ создание большого количества объектов и управление ими может привести к дополнительным затратам памяти и ресурсов процессора. Благодаря общему состоянию шаблон снижает эту нагрузку, что приводит к повышению эффективности и скорости отклика приложения.

✅ __Улучшенное обслуживание:__ легковесные объекты, как правило, имеют небольшой размер и самодостаточны. Это упрощает обслуживание и понимание кодовой базы, поскольку вам нужно управлять меньшим количеством классов и объектов, особенно при работе с множеством схожих сущностей.

✅ __Согласованность:__ поскольку общее внутреннее состояние централизовано в легковесных объектах, это обеспечивает согласованность в приложении. Изменения внутреннего состояния отражаются во всех объектах, которые используют это состояние, что способствует целостности данных.

✅ __Управление ресурсами:__ в ресурсоёмких приложениях (например, для рендеринга графики или игр) шаблон Flyweight помогает эффективно управлять ресурсами, такими как текстуры, шрифты или сетки, распределяя их между несколькими экземплярами.

✅ __Кастомизация:__ несмотря на то, что внутреннее состояние является общим, внешнее состояние может быть настроено индивидуально для каждого объекта. Это позволяет при необходимости обеспечить индивидуальность и уникальность, оптимизируя при этом использование памяти для общих свойств.

## Недостатки шаблона проектирования Фасад
❌ __Сложность:__ Реализация шаблона проектирования «Лёгкий вес» может привести к усложнению вашей кодовой базы, особенно при управлении разделением внутренних и внешних состояний. Из-за этой сложности код может быть непонятен разработчикам, не знакомым с этим шаблоном.

❌ __Увеличение объёма кодовой базы:__ для реализации шаблона может потребоваться создание нескольких классов и интерфейсов, в том числе интерфейса Flyweight, Concrete Flyweight и Flyweight Factory. Это может привести к увеличению объёма кодовой базы, что может оказаться излишним для более простых приложений.

❌ __Накладные расходы на производительность:__ в некоторых случаях логика поиска и создания объектов в Flyweight Factory может приводить к небольшим накладным расходам на производительность. Хотя обычно они незначительны, в приложениях, критичных к производительности, они могут вызывать беспокойство.

❌ __Поддержание внешнего состояния:__ Управление внешним состоянием (уникальным состоянием) легковесных объектов может оказаться непростой задачей. Разработчикам необходимо убедиться, что внешнее состояние правильно назначено легковесным экземплярам, что может привести к ошибкам.

❌ __Ограниченная применимость:__ паттерн «Лёгкий вес» наиболее эффективен при наличии значительного общего внутреннего состояния. В ситуациях, когда у объектов практически нет общего состояния, реализация паттерна может не принести заметных преимуществ и привести к ненужной сложности.

❌ __Безопасность потоков:__ Обеспечение безопасности потоков при работе с общими флайверами может быть непростой задачей, особенно в многопоточных приложениях. Разработчикам необходимо тщательно продумывать механизмы синхронизации, чтобы избежать состояния гонки.

❌ __Негибкость:__ в некоторых случаях паттерн Flyweight может привести к негибкости. Например, если вам нужно изменить внутреннее состояние конкретного экземпляра, не затрагивая другие, этот паттерн может вам не подойти.

❌ __Сложная инициализация:__ в зависимости от сложности внутреннего состояния и способа его передачи инициализация легковесных объектов и поддержание их состояния могут быть затруднительными, что потенциально может привести к проблемам, связанным с инициализацией.

❌ __Отладка:__ Отладка приложений, использующих шаблон Flyweight, может быть более сложной задачей, поскольку несколько объектов могут иметь одно и то же внутреннее состояние. Для определения того, какой экземпляр вызывает ту или иную проблему, могут потребоваться дополнительные усилия.

❌ __Издержки для небольших коллекций:__ в сценариях, где у вас небольшая коллекция объектов или где большинство объектов имеют уникальные внутренние состояния, издержки, связанные с реализацией шаблона Flyweight, могут быть неоправданными.

## Где применяется?
1. Текстовые редакторы
2. Рендеринг графики
3. Разработка игр
4. Финансовое программное обеспечение
5. Географические информационные системы (ГИС)